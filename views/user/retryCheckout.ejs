<%- include('../layouts/userLayouts/header') %>
<div class="bg-white sticky-top">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white">
    <div class="container">
      <!-- Logo with Dummy Image -->
      <a class="navbar-brand d-flex align-items-center" href="">
        <span style="font-size: 32px; font-weight: bold; color: black"
          >AXIOS</span
        ><sup style="color: black">Â®</sup>
      </a>
      <!-- Search Form -->
      <form
        class="d-flex mx-auto w-50"
        id="searchForm"
        action="/showcase"
        method="GET"
      >
        <input
          class="form-control search-bar"
          style="
            border: none;
            box-shadow: 0px 0px 6px rgba(0, 0, 0, 0.3);

            padding: 20px 15px;
            border-radius: 5px;
            height: 48px;
          "
          type="search"
          name="searchProduct"
          placeholder="Search for items..."
          aria-label="Search"
          value="<%= searchProduct || '' %>"
        />
      </form>

      <!-- Icons -->
      <ul
        style="margin-right: 10px"
        class="navbar-nav mb-2 mb-lg-0 d-flex align-items-center"
      >
        <li class="nav-item me-3">
          <a
            class="nav-link"
            href="/wishlist"
            style="color: black; font-weight: bold; font-size: 24px"
          >
            <i class="fi-rs-heart"></i>
          </a>
        </li>
        <li class="nav-item me-3">
          <a
            class="nav-link"
            href="/cart"
            style="color: black; font-weight: bold; font-size: 24px"
          >
            <i class="fi-rs-shopping-cart"></i>
          </a>
        </li>
        <li class="nav-item me-3">
          <a
            class="nav-link"
            href="/profile"
            style="color: black; font-weight: bold; font-size: 24px"
          >
            <i class="fi-rs-user"></i>
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <div class="container" style="height: 70px">
    <div class="row">
      <div class="col-12 text-center mt-3">
        <ul style="user-select: none" class="list-inline">
          <li class="list-inline-item">
            <a
              href="/showcase?targetGroup=men"
              style="
                color: black;
                font-weight: bold;
                font-size: 20px;
                padding-right: 10px;
              "
              >Mens</a
            >
          </li>
          <li class="list-inline-item">
            <a
              href="/showcase?targetGroup=women"
              style="
                color: black;
                font-weight: bold;
                font-size: 20px;
                padding-right: 10px;
              "
              >Womens</a
            >
          </li>
          <li class="list-inline-item">
            <a
              href="/showcase?targetGroup=kids"
              style="
                color: black;
                font-weight: bold;
                font-size: 20px;
                padding-right: 10px;
              "
              >Kids</a
            >
          </li>
          <li class="list-inline-item">
            <a
              href="/"
              style="
                color: black;
                font-weight: bold;
                font-size: 20px;
                padding-right: 10px;
              "
              >About Us</a
            >
          </li>
          <li class="list-inline-item">
            <a
              href="/"
              style="
                color: black;
                font-weight: bold;
                font-size: 20px;
                padding-right: 10px;
              "
              >Contact</a
            >
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

<main class="container my-5">
  <h1
    style="
      font-family: 'Roboto', sans-serif;
      font-size: 24px;
      font-weight: 600;
      color: #333;
      margin-bottom: 16px;
      letter-spacing: 0.5px;
    "
    class="h2 mb-4"
  >
    Retry Payment
  </h1>

  <div class="row">
    <div class="col-lg-8">
      <!-- Order Details Section -->
      <div
        class="order-details"
        style="
          background-color: #f5f5f5;
          padding: 20px;
          border-radius: 4px;
          margin-bottom: 20px;
        "
      >
        <h5 class="mb-4">Order Details</h5>

        <% orderData.items.slice(0, 2).forEach(item=> { %> <% if (item.images &&
        item.images.length> 0) { %>
        <div class="d-flex align-items-center flex-wrap">
          <% const fullPath=item.images[0]; const
          filename=fullPath.split('\\').pop().split('/').pop(); %>
          <img
            src="/productImages/<%= filename %>"
            alt="Item Image"
            style="
              width: 50px;
              height: 50px;
              margin-right: 10px;
              margin-bottom: 10px;
            "
          />
        </div>
        <% } %> <% }) %> <% if (orderData.items.length> 2) { %>
        <div class="d-flex justify-content-between mt-2">
          <span> <%= orderData.items.length - 2 %>+ more items </span>
        </div>
        <% } %>
      </div>

      <!-- Customer Information Section -->
      <div
        class="customer-info"
        style="
          background-color: #f5f5f5;
          padding: 20px;
          border-radius: 4px;
          margin-bottom: 20px;
        "
      >
        <h5 class="mb-4">Customer Information</h5>
        <p style="margin: 0">
          <strong>Delivery Address:</strong>
          <%= orderData.shippingAddress.address %>, <%=
          orderData.shippingAddress.locality %>, <%=
          orderData.shippingAddress.cityDistTown %>, <%=
          orderData.shippingAddress.state %>, <%=
          orderData.shippingAddress.pincode %>
        </p>
        <p>
          <strong>Contact:</strong>
          <%= orderData.shippingAddress.email %>
        </p>
      </div>

      <!-- Troubleshooting Tips -->
      <div
        class="troubleshooting-tips"
        style="
          background-color: #f5f5f5;
          padding: 20px;
          border-radius: 4px;
          margin-bottom: 20px;
        "
      >
        <h5 class="mb-4">Troubleshooting Tips</h5>
        <p style="margin: 0">
          If you encounter any issues with the payment, please refer to our
          <a href="/faq">FAQ page</a> or contact our
          <a href="/support">support team</a>.
        </p>
      </div>
    </div>

    <div class="col-lg-4">
      <!-- Order Summary Section -->
      <div
        class="order-summary"
        style="
          background-color: #f5f5f5;
          padding: 20px;
          border-radius: 4px;
          margin-bottom: 20px;
        "
      >
        <h5 class="mb-4">Order Summary</h5>
        <p class="d-flex justify-content-between">
          <span>SubTotal Amount</span>
          <span>Rs <%= orderData.subTotalAmount %></span>
        </p>
        <p class="d-flex justify-content-between">
          <span>Coupon Discount</span>
          <span>Rs <%= orderData.discountAmount %></span>
        </p>
        <hr />
        <p class="d-flex justify-content-between">
          <strong>Total Amount</strong>
          <strong>Rs <%= orderData.totalAmount %></strong>
        </p>
      </div>
      <!-- Retry Payment Button -->
      <button
        type="button"
        class="btn btn-primary btn-lg w-100"
        data-order-id="<%= orderData._id %>"
        id="retryPayment"
      >
        Retry Payment
      </button>
    </div>
  </div>
</main>

<script>
  const retryPaymentButton = document.getElementById("retryPayment");
  const orderId = retryPaymentButton.getAttribute("data-order-id");

  retryPaymentButton.addEventListener("click", () => {
    const paymentFailure = async (response) => {
      try {
        const { payment_id, order_id } = response.error.metadata;

        const dataResponse = await fetch("/payments/failure", {
          method: "PATCH",

          headers: {
            "Content-Type": "application/json",
          },

          body: JSON.stringify({ paymentId: payment_id, orderId: order_id }),
        });

        if (!dataResponse.ok) {
          throw new Error(
            "Failed to notify the server about the payment failure"
          );
        }

        const result = await dataResponse.json();

        if (result.success) {
          Swal.fire({
            icon: "error",
            text: "Online Payment failed!",
            toast: true,
            position: "top-right",
            showConfirmButton: false,
            timerProgressBar: true,
            timer: 3000,
          }).then(() => {
            window.location.href = "/payments/failure";
          });
        }
      } catch (error) {
        console.error("Error handling payment failure:", error.message);
        Swal.fire({
          icon: "error",
          text: "Error while handling payment failure.",
          confirmButtonText: "OK",
          confirmButtonColor: "#000000",
        });
      }
    };

    fetch("/retryPayment", {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
      },

      body: JSON.stringify({ orderId: orderId }),
    })
      .then((response) => response.json())

      .then((data) => {
        if (data.success) {
          const options = {
            key: data?.RAZORPAY_ID_KEY,
            amount: data?.amount * 100,
            currency: "INR",
            name: "axios watches",
            order_id: data?.razorPayOrderPaymentId,
            handler: (response) => {
              verifyOnlinePayment(
                response?.razorpay_payment_id,
                response?.razorpay_order_id,
                response?.razorpay_signature,
                response?.amount
              );
            },
          };

          let rzp = new Razorpay(options);

          rzp.on("payment.failed", paymentFailure);
          rzp.open();
        } else {
          Swal.fire({
            icon: "error",
            text: `${data.message}`,
            confirmButtonText: "OK",
            confirmButtonColor: "#000000",
          }).then(() => {
            window.location.href = "/payments/failure";
          });
        }
      })
      .catch((error) => {
        Swal.fire({
          icon: "error",
          text: `An error occurred: ${error.message}`,
          confirmButtonText: "OK",
          confirmButtonColor: "#000000",
        });
      });
  });

  const verifyOnlinePayment = (paymentId, orderId, signature, amount) => {
    fetch("/payments/verify", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ paymentId, orderId, signature, amount }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          Swal.fire({
            icon: "success",
            text: "Payment successful!",
            toast: true,
            position: "top-right",
            showConfirmButton: false,
            timerProgressBar: true,
            timer: 3000,
          }).then(() => {
            window.location.href = "/orders/confirmation?view=confirmation";
          });
        } else {
          Swal.fire({
            icon: "error",
            text: "Payment verification failed. Please contact support.",
            confirmButtonText: "OK",
            confirmButtonColor: "#000000",
          });
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        Swal.fire({
          icon: "error",
          text: "An error occurred during payment verification.",
          confirmButtonText: "OK",
          confirmButtonColor: "#000000",
        });
      });
  };
</script>
<%- include('../layouts/userLayouts/footer') %>
