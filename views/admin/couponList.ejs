<%- include('../layouts/adminLayouts/header') %>
<div class="screen-overlay"></div>
<%- include('../layouts/adminLayouts/sidebar') %>
<main class="main-wrap">
  <%- include('../layouts/adminLayouts/searchbar') %>

  <section class="content-main">
    <div class="content-header">
      <div>
        <h2 class="content-title card-title">Coupons List</h2>
        <p>Dashboard > Coupons</p>
      </div>
      <div>
        <a href="/admin/coupons?view=add" class="btn btn-primary btn-sm rounded">Add Coupon</a>
      </div>
    </div>

    <div class="card mb-4">
      <header class="card-header">
        <form action="/admin/coupons" method="get" style="padding-left: 20px; padding-right: 20px;">
            <div class="row gx-3">
                <div class="col-lg-4 col-md-6 me-auto" style="margin-top: 20px;">
                    <div class="input-group w-100">
                        <input type="text" name="search" class="form-control" placeholder="Search term" value="<%= search %>">
                        <button class="btn btn-light bg" type="submit">
                            <i class="material-icons md-search"></i>
                        </button>
                    </div>
                </div>
    
                <!-- Status Filter Dropdown -->
                 
                <div class="col-lg-2 col-6 col-md-3" style="margin-top: 20px;">
                    <select name="status" class="form-select" onchange="this.form.submit();">
                        <option value="" <%= statusFilter === '' ? 'selected' : '' %>>Show all</option>
                        <option value="Active" <%= statusFilter === 'Active' ? 'selected' : '' %>>Active</option>
                        <option value="Inactive" <%= statusFilter === 'Inactive' ? 'selected' : '' %>>Inactive</option>
                    </select>
                </div>
            </div>
            <input type="hidden" name="view" value="list">
        </form>
    </header>
    

      <div class="card-body">
        <%if (couponsData.length === 0) { %>
         
            <p  class="text-center">No Coupons Available</p>

          
          <%} else { %>
        <div class="table-responsive">
          <table class="table table-hover" id="couponTable">
            <thead>
              <tr>
                <th scope="col">No</th>
                <th scope="col">Coupon Name</th>
                <th scope="col">Code</th>
                <th scope="col">Discount</th>
                <th scope="col">Min Purchase Amount</th>
                <th scope="col">Max Discount Amount</th>
             
                <th scope="col" class="text-end">Action</th>
              </tr>
            </thead>

            <tbody id="couponTableBody">
            
              <% couponsData.forEach((coupon, index) => { %>
                <tr>
                  <td><%= index + 1 %></td>
                  <td><%= coupon.couponName %></td>
                  <td><%= coupon.couponCode %></td>
                  <td><%= coupon.couponDiscount %></td>
                  <td><%= coupon.minAmount %></td>
                  <td><%= coupon.maxAmount %></td>
                  <td class="text-end">
                      <a href="/admin/coupons/<%= coupon._id %>?view=edit" class="btn btn-primary">Edit Coupon</a>
                    <% if (coupon.couponStatus) { %>
                    <button  style="width: 120px; height: 40px; font-size: 14px; padding: 0.5rem;" onclick="softDeleteCoupon('<%= coupon._id %>')" id="softDeleteButton<%= coupon._id %>" class="btn btn-danger rounded btn-sm font-sm flex-fill mx-1">Deactivate</button>
                    <% } else { %>
                     <button   style="width: 120px; height: 40px; font-size: 14px; padding: 0.5rem;" onclick="softDeleteCoupon('<%= coupon._id %>')" id="softDeleteButton<%= coupon._id %>" class="btn btn-success  rounded btn-sm font-sm flex-fill mx-1">Activate</button>
                      <% } %>
                  </td>
                </tr>
              <% }); %>
              <%}%>
            </tbody>
          </table>
        </div>
      </div>
      
    </div>


    <div class="pagination-area mt-30 mb-50">
      <nav aria-label="Page navigation example">
          <ul class="pagination justify-content-start">
              <% if (currentPage > 1) { %>
                  <li class="page-item">
                      <a class="page-link" href="/admin/coupons?view=list&page=<%= currentPage - 1 %>&search=<%= search %>&status=<%= statusFilter %>">
                          <strong>&lt;</strong>
                      </a>
                  </li>
              <% } %>
              
              <% 
              let startPage = Math.max(1, currentPage - 2);
              let endPage = Math.min(totalPages, startPage + 4);
              if (endPage - startPage < 4) {
                  startPage = Math.max(1, endPage - 4);
              }
              %>
              
              <% for (let i = startPage; i <= endPage; i++) { %>
                  <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                      <a class="page-link" href="/admin/coupons?view=list&page=<%= i %>&search=<%= search %>&status=<%= statusFilter %>">
                          <strong><%= i %></strong>
                      </a>
                  </li>
              <% } %>
              
              <% if (currentPage < totalPages) { %>
                  <li class="page-item">
                      <a class="page-link" href="/admin/coupons?view=list&page=<%= currentPage + 1 %>&search=<%= search %>&status=<%= statusFilter %>">
                          <strong>&gt;</strong>
                      </a>
                  </li>
              <% } %>
          </ul>
      </nav>
  </div>
  </section>
</main>
<script>
const applySwalButtonStyles = () => {
    const confirmButton = Swal.getConfirmButton();
    const cancelButton = Swal.getCancelButton();

    confirmButton.style.width = '100%';
    confirmButton.style.margin = '5px 0';
    confirmButton.style.border = '1px solid #000';
    confirmButton.style.borderRadius = '0.25rem';
    confirmButton.style.backgroundColor = '#000';
    confirmButton.style.color = '#fff';

    cancelButton.style.width = '100%';
    cancelButton.style.margin = '5px 0';
    cancelButton.style.border = '1px solid #000';
    cancelButton.style.borderRadius = '0.25rem';
    cancelButton.style.color = '#000';

    if (window.innerWidth <= 768) {
        confirmButton.style.width = '100%';
        cancelButton.style.width = '100%';
    } else if (window.innerWidth > 768 && window.innerWidth <= 992) {
        confirmButton.style.width = '150px';
        cancelButton.style.width = '150px';
    }
};

    const softDeleteCoupon = async (couponId) =>{

      const deleteButton = document.getElementById(`softDeleteButton${couponId}`)
      const isBlocking = deleteButton.classList.contains('btn-success')
      const result = await Swal.fire({
        title: `Are you sure you want to ${isBlocking ? "Activate" : "Deactivate"} this coupon?`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#ffffff",
        confirmButtonText: `Yes, ${isBlocking ? "Activate" : "Deactivate"}`,
        didOpen: () => {
          applySwalButtonStyles();
        },
      })

    if (result.isConfirmed) {
    try {
      const response = await fetch(`/admin/coupons/${couponId}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
        },
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || "Network response was not ok");
      }

      const data = await response.json();

      if (data.couponData.couponStatus) {
        deleteButton.classList.remove("btn-success");
        deleteButton.classList.add("btn-danger");
        deleteButton.textContent = "Deactivate";

        await Swal.fire({
          text: "This coupon is now active.",
          icon: "success",
          toast: true,
          position: "top-right",
          showConfirmButton: false,
          timerProgressBar: true,
          timer: 3000,
        });
      } else {
        deleteButton.classList.remove("btn-danger");
        deleteButton.classList.add("btn-success");
        deleteButton.textContent = "Activate";

        await Swal.fire({
          text: "This coupon is no longer available.",
          icon: "success",
          toast: true,
          position: "top-right",
          showConfirmButton: false,
          timerProgressBar: true,
          timer: 3000,
        });
      }
    } catch (error) {
      console.error("There was a problem with the fetch operation:", error);
      await Swal.fire({
        title: "Error!",
        text: `Error: ${error.message || "There was an issue processing your request."}`,
        icon: "error",
        toast: true,
        position: "top-right",
        showConfirmButton: false,
        timerProgressBar: true,
        timer: 3000,
      });
    }
  }
}
</script>
<%- include('../layouts/adminLayouts/footer') %>