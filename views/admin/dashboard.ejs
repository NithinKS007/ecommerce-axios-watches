<%- include('../layouts/adminLayouts/header') %>
    <%- include('../layouts/adminLayouts/sidebar') %>
        <main class="main-wrap">
            <%- include('../layouts/adminLayouts/searchbar') %>
                <section class="content-main">
                    <div class="content-header">
                        <div>
                            <h2 class="content-title card-title">Dashboard </h2>
                            <p>Whole data about your business here</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-3">
                            <div class="card card-body mb-4">
                                <article class="icontext">
                                    <span class="icon icon-sm rounded-circle bg-primary-light"><i
                                            class="text-primary material-icons md-monetization_on"></i></span>
                                    <div class="text">
                                        <h6 class="mb-1 card-title">Total Revenue</h6>
                                        <span>Rs <%= totalRev || 0 %></span>
                                        <span class="text-sm">
                                            Shipping fees are not included
                                        </span>
                                    </div>
                                </article>
                            </div>
                        </div>
                        <div class="col-lg-3">
                            <div class="card card-body mb-4">
                                <article class="icontext">
                                    <span class="icon icon-sm rounded-circle bg-success-light"><i
                                            class="text-success material-icons md-local_shipping"></i></span>
                                    <div class="text">
                                        <h6 class="mb-1 card-title">Orders</h6> <span><%= totalOrders || 0 %></span>
                                        <span class="text-sm">
                                            Total orders
                                        </span>
                                    </div>
                                </article>
                            </div>
                        </div>
                        <div class="col-lg-3">
                            <div class="card card-body mb-4">
                                <article class="icontext">
                                    <span class="icon icon-sm rounded-circle bg-warning-light"><i
                                            class="text-warning material-icons md-qr_code"></i></span>
                                    <div class="text">
                                        <h6 class="mb-1 card-title">Products</h6> <span><%= totalProducts || 0 %></span>
                                        <span class="text-sm">
                                          In <%= totalCategories || 0 %> Categories
                                        </span>
                                    </div>
                                </article>
                            </div>
                        </div>
                        <div class="col-lg-3">
                            <div class="card card-body mb-4">
                                <article class="icontext">
                                    <span class="icon icon-sm rounded-circle bg-info-light"><i
                                            class="text-info material-icons md-shopping_basket"></i></span>
                                            <div class="text">
                                                <h6 class="mb-1 card-title">Monthly Average</h6> 
                                                <span>Rs <%= monthlyRev || 0 %></span>
                                                <span class="text-sm">
                                                    <%= new Date(startOfMonth).toLocaleDateString('en-GB') || 'N/A' %> To (<%= new Date().toLocaleDateString('en-GB')  || 'N/A' %>)
                                                </span>
                                            </div>
                                </article>
                            </div>
                        </div>
                    </div>
                    <!-- <div class="row">
                        <div class="col-xl-8 col-lg-12">
                            <div class="card mb-4">
                                <article class="card-body">
                                    <h5 class="card-title">Sale statistics</h5>
                                    <canvas id="myChart" height="120px"></canvas>
                                </article>
                            </div>
                            <div class="row">
                               
                            </div>
                        </div>
                       
                    </div> -->
                    
                    <div class="container mt-5 p-3">
                        <h2 class="m-4">SALES REPORT</h2>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="date" id="dateFrom" class="form-control" placeholder="dd-mm-yyyy">
                                    <span class="input-group-text">to</span>
                                    <input type="date" id="dateTill" class="form-control" placeholder="dd-mm-yyyy">
                                    <button class="btn btn-primary" onclick="customDate()" type="button">Apply</button>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-primary" onclick="Sales('today')">Today's</button>
                                <button class="btn btn-primary" onclick="Sales('week')">This Week</button>
                                <button class="btn btn-primary" onclick="Sales('month')">This Month</button>
                            </div>
                        </div>
                        
                    
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">Overall Sales Count</h6>
                                        <p class="overall-stats text-success"><%= totalSalesC || 0 %></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">Overall Order Amount</h6>
                                        <p class="overall-stats">₹ <%= overallSalesTotalAmount || 0 %></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">Overall Discount</h6>
                                        <p class="overall-stats">₹ <%= overAllDiscountAmount || 0 %></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th id="tableDateHeader">Date</th>
                                        <th id="tableOrdersHeader">Orders</th>
                                        <th id="tableGrossSalesHeader">Gross Sales</th>
                                        <th id="tableCouponDeductionsHeader">Coupon Deductions</th>
                                        <th id="tableNetSalesHeader">Net Sales</th>
                                    </tr>
                                </thead>
                                <tbody id="salesTableBody">
                                    <tr>
                                      
                                        <td><%= date || 'N/A' %></td>
                                        <td><%= totalNumberOfOrders || 0 %></td>
                                        <td>₹ <%= grossSales || 0 %></td>
                                        <td>₹ <%= couponDeductions || 0 %></td>
                                        <td>₹ <%= netSales || 0 %></td>
                                    </tr>
                                    
                                    
                                </tbody>
                                <tfoot class="table-light"  id="salesTableFooter">
                                    <tr>
                                        <td><%= date ? 'Total' : date %></td>
                                        <td><%=tableTotalNumberOfOrders|| 0 %> </td>
                                        <td>₹ <%= tableTotalGrossSales ||  0 %></td>
                                        <td>₹ <%= tableTotalCouponDeductions ||  0%></td>
                                        <td>₹ <%= tableTotalNetSales||  0 %></td>
                                    </tr>
                                </tfoot>
                            </table>
                           
                        </div>
                        
                        <div class="text-end mt-3">
                            <button class="btn btn-primary">Download PDF</button>
                            <button class="btn btn-primary">Download Excel</button>
                        </div>
                    </div>
                    
                    

    


                    </div>
                    
                </section> <!-- content-main end// -->
        </main>
        <script>
               document.addEventListener('DOMContentLoaded', () => {
            // Retrieve the success message from EJS variable
            let successMessage = '<%= successMessage %>';

            if (successMessage) {
                Swal.fire({
                    text: successMessage,
                    icon: 'success',
                    toast: true,
                    position: 'top-right',
                    showConfirmButton: false,
                    timer: 5000
                });
            }
        });

 const sendDataToBackend = async (dateFrom, dateTill, period) => {
    try {
       
        const url = new URL('http://localhost:7000/admin/salesReport');

        const params = new URLSearchParams();

        if (dateFrom && dateTill) {
            params.append('dateFrom', dateFrom);
            params.append('dateTill', dateTill);
        } else if (period) {
            params.append('period', period);
        }

       
        url.search = params.toString();

        const response = await fetch(url, {

            method: 'GET',
            headers: {

                'Content-Type': 'application/json'
            },
        });

        if (response.ok) {

            const data = await response.json();
            
            console.log(data);

            updateSalesTable(data.salesData,data.tableTotalNumberOfOrders,data.tableTotalGrossSales,data.tableTotalCouponDeductions,data.tableTotalNetSales); 

        } else {

            throw new Error('Failed to fetch data');

        }

    } catch (error) {
        console.log(`Error while sending data to backend: ${error.message}`);
        await Swal.fire({
            icon: 'error',
            text: `Error: ${error.message}`,
            toast: true,
            position: 'top-right',
            showConfirmButton: false,
            timerProgressBar: true,
            timer: 3000
        });
    }
};

const customDate = () => {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTill = document.getElementById('dateTill').value;

    if (dateFrom && dateTill) {

        document.getElementById('tableDateHeader').textContent = 'Date';
        document.getElementById('tableOrdersHeader').textContent = 'Orders';
        document.getElementById('tableGrossSalesHeader').textContent = 'Gross Sales';
        document.getElementById('tableCouponDeductionsHeader').textContent = 'Coupon Deductions';
        document.getElementById('tableNetSalesHeader').textContent = 'Net Sales';

        sendDataToBackend(dateFrom, dateTill);

    } else {

        alert('Please select both dates.');
    }
};

const updateSalesTable = (salesData,tableTotalNumberOfOrders,tableTotalGrossSales,tableTotalCouponDeductions,tableTotalNetSales) =>{

    const tableBody = document.getElementById('salesTableBody')
    const footerRow = document.getElementById('salesTableFooter')

    tableBody.innerHTML = '';

    if(salesData.length===0){

        tableBody.innerHTML = `
         <tr>
                <td>N/A</td>
                <td>0</td>
                <td>₹0</td>
                <td>₹0</td>
                <td>₹0</td>
            </tr>

        `
        if (footerRow) {
            console.log("Element found:", footerRow)
        footerRow.innerHTML = `
            <td> Total</td>
            <td>0</td>
            <td>₹ 0</td>
            <td>₹ 0</td>
            <td>₹ 0</td>
        `;
        console.log("InnerHTML set successfully.");
    } else {

        console.error('Footer row element not found.');
    }
    }else{


        salesData.forEach(sale => {
            const rowHtml = `
                <tr>
                    <td>${sale.date || '--'}</td>
                    <td>${sale.totalNumberOfOrders || 0}</td>
                    <td>₹${sale.grossSales || 0}</td>
                    <td>₹${sale.couponDeductions || 0}</td>
                    <td>₹${sale.netSales || 0}</td>
                </tr>
            `;
            tableBody.insertAdjacentHTML('beforeend', rowHtml);
           
        });

        footerRow.innerHTML = `
             <td>Total</td>
            <td>${tableTotalNumberOfOrders}</td>
            <td>₹${tableTotalGrossSales}</td>
            <td>₹${tableTotalCouponDeductions}</td>
            <td>₹${tableTotalNetSales}</td>
        `;
    }
}
const Sales = (period) => {
   
    const tableDateHeader = document.getElementById('tableDateHeader');
    const tableOrdersHeader = document.getElementById('tableOrdersHeader');
    const tableGrossSalesHeader = document.getElementById('tableGrossSalesHeader');
    const tableCouponDeductionsHeader = document.getElementById('tableCouponDeductionsHeader');
    const tableNetSalesHeader = document.getElementById('tableNetSalesHeader');

    switch (period) {
        case 'today':
            tableDateHeader.textContent = 'Today’s Date';
            tableOrdersHeader.textContent = 'Today’s Orders';
            tableGrossSalesHeader.textContent = 'Today’s Gross Sales';
            tableCouponDeductionsHeader.textContent = 'Today’s Coupon Deductions';
            tableNetSalesHeader.textContent = 'Today’s Net Sales';
            break;
        case 'week':
            tableDateHeader.textContent = 'This Week';
            tableOrdersHeader.textContent = 'Weekly Orders';
            tableGrossSalesHeader.textContent = 'Weekly Gross Sales';
            tableCouponDeductionsHeader.textContent = 'Weekly Coupon Deductions';
            tableNetSalesHeader.textContent = 'Weekly Net Sales';
            break;
        case 'month':
            tableDateHeader.textContent = 'This Month';
            tableOrdersHeader.textContent = 'Monthly Orders';
            tableGrossSalesHeader.textContent = 'Monthly Gross Sales';
            tableCouponDeductionsHeader.textContent = 'Monthly Coupon Deductions';
            tableNetSalesHeader.textContent = 'Monthly Net Sales';
            break;
        default:
      
            tableDateHeader.textContent = 'Date';
            tableOrdersHeader.textContent = 'Orders';
            tableGrossSalesHeader.textContent = 'Gross Sales';
            tableCouponDeductionsHeader.textContent = 'Coupon Deductions';
            tableNetSalesHeader.textContent = 'Net Sales';
            break;
    }

    
    sendDataToBackend(null, null, period);
};
        </script>
        <%- include('../layouts/adminLayouts/footer') %>