<script>
          placeOrderBtn.addEventListener('click', () => {
          const addressRadios = placeOrderForm.querySelectorAll('input[name="address"]');
          const selectedAddress = Array.from(addressRadios).find(radio => radio.checked);

          if (!selectedAddress) {
            Swal.fire({
              title: 'Reminder',
              text: 'Please select address',
              icon: 'warning'
            });
            return;
          }

          const paymentMethodRadio = document.querySelectorAll('input[name="paymentMethod"]');
          let paymentMethod = null;
          paymentMethodRadio.forEach(method => {
            if (method.checked) {
              paymentMethod = method.value;
            }
          });

          console.log(paymentMethod, "Payment Method");
          console.log("working");
          if (!paymentMethod) {
            Swal.fire({
              title: 'Reminder',
              text: 'Payment method pending',
              icon: 'warning'
            });
            return;
          }

          console.log("working test");

          fetch('/cart/items', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          })
            .then(response => response.json())
            .then(data => {
              const cartItems = data.items;
              console.log("data", data);
              // Check if any product is out of stock
              const outOfStockProducts = cartItems.filter(item => item.productId.countInStock < item.quantity);
              if (outOfStockProducts.length > 0) {
                const outOfStockProductNames = outOfStockProducts.map(item => item.productId.name).join(', ');
                Swal.fire({
                  title: 'Out of Stock',
                  text: The following products are out of stock: ${outOfStockProductNames},
                  icon: 'warning',
                });
                return; // Stop further execution
              } else {

</script>


                const addressId = selectedAddress.value;

                const orderNotes = document.getElementById('orderNotes').value;

                const totalAmount = parseFloat(document.getElementById('totalAmount').textContent.replace('₹', ''));
                const couponDiscount = parseFloat(document.getElementById('couponDiscount').textContent.replace('₹', ''));

                console.log("ta", totalAmount);
                console.log("c", couponDiscount);


                if (paymentMethod === "Cash On Delivery" && totalAmount > 1000) {
                  console.log("tereefkjaghlkfhla");
                  Swal.fire({
                    title: 'Warning',
                    text: 'Above 1000 INR order is not allowed for Cash on Delivery',
                    icon: 'warning'
                  });
                  return;
                }


                if (paymentMethod == "Cash On Delivery") {

                  fetch('/checkout', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',

                    },
                    body: JSON.stringify({ addressId, paymentMethod, orderNotes, totalAmount, couponDiscount }),
                  })
                    .then(response => {
                      if (response.ok) {

                        console.log('Order placed successfully');
                        window.location.href = '/orderPlaced';

                      } else {

                        console.error('Failed to place order');

                      }
                    })
                    .catch(error => {
                      console.error('Error:', error);

                    });
                } else if (paymentMethod == "Razorpay") {

                  createRazorpayOrder(totalAmount)
                  function createRazorpayOrder(totalAmount) {
                    fetch('/create/razorpayOrder', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({ totalAmount })
                    })
                      .then(response => response.json())
                      .then(data => {
                        console.log("TEST", data);
                        const options = {
                          key: 'rzp_test_U3ASSzGpya8Oey',
                          amount: data.amount,
                          order_id: data.id,
                          name: 'Wander',
                          description: 'Payment for Order',
                          handler: function (response) {
                            console.log('payment successfull', response);
                            placeOrderAfterPayment('Success');
                          }
                          ,
                          theme: {
                            color: '#002D75'
                          }
                        };

                        const rzp = new Razorpay(options);
                        rzp.on('payment.failed', function (response) {
                          handlePaymentFailure(response);

                          function handlePaymentFailure(response) {
                            Swal.fire({
                              title: 'Payment Failed',
                              text: 'Your payment failed. Please try again.',
                              icon: 'error',
                              allowOutsideClick: false,
                            }).then((result) => {
                              console.log("Working")
                              if (result.isConfirmed) {
                                console.log("Working-2")
                                placeOrderAfterPayment('Failed')
                                  .then(() => {
                                    window.location.href = '/orderFailed';
                                  })
                                  .catch(error => {
                                    console.error('Error placing order:', error);
                                  })
                              }
                            })
                          }

                        })
                        rzp.open();
                      })
                      .catch(error => {
                        console.error('Error creating RazorPay order:', error);
                      })
                  }

                  function placeOrderAfterPayment(paymentStatus) {

                    fetch('/checkout', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',

                      },
                      body: JSON.stringify({ addressId, paymentMethod, orderNotes, paymentStatus, totalAmount, couponDiscount }),
                    })
                      .then(response => {
                        if (response.ok) {

                          console.log('Order placed successfully');
                          if (paymentStatus == "Success") {
                            window.location.href = '/orderPlaced';
                          } else {
                            window.location.href = '/orderFailed';
                          }


                        } else {

                          console.error('Failed to place order');

                        }
                      })
                      .catch(error => {
                        console.error('Error:', error);

                      })
                  }

                } else if (paymentMethod == "Wallet") {
                  // Check if wallet balance is sufficient
                  fetch('/wallet/balance', {
                    method: 'GET',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                  })
                    .then(response => response.json())
                    .then(data => {
                      const walletBalance = data.walletBalance;
                      const totalAmount = parseFloat(document.getElementById('totalAmount').textContent.replace('₹', ''));
                      console.log("wa", walletBalance);
                      console.log("ot", totalAmount);
                      if (walletBalance >= totalAmount) {
                        // Wallet balance is sufficient, proceed with order placement
                        placeOrderWithWallet(addressId, paymentMethod, orderNotes, totalAmount, couponDiscount);
                      } else {
                        // Wallet balance is insufficient
                        Swal.fire({
                          title: 'Insufficient Balance',
                          text: 'Your wallet balance is insufficient. Please choose another payment option.',
                          icon: 'warning',
                        });
                      }
                    })
                    .catch(error => {
                      console.error('Error:', error);
                    });

                }

                function placeOrderWithWallet(addressId, paymentMethod, orderNotes, totalAmount, couponDiscount) {
                  fetch('/checkout', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ addressId, paymentMethod, orderNotes, totalAmount, couponDiscount }),
                  })
                    .then(response => {
                      if (response.ok) {
                        console.log('Order placed successfully');
                        window.location.href = '/orderPlaced';
                      } else {
                        console.error('Failed to place order');
                      }
                    })
                    .catch(error => {
                      console.error('Error:', error);
                    });
                }
              }

            })
            .catch(error => {
              console.error('Error:', error); // Handle error here
            });

        })


</script>